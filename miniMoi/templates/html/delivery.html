{% extends "html/base.html" %}

{% block title %} {{ delivery_title }} {% endblock %}

{% block body %}

<!-- Header -->
<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <h1 class="display-4">{{ delivery_title }}</h1>
    <p class="lead">{{ delivery_lead }}</p>
</div>

<!-- settings -->
<div class="container">
    
    <!-- buttons row -->
    <div class="row force-min-height">

        <div class="col-4" id="fetchReport">
            <button type="button" class="btn btn-lg btn-block btn-info" onClick="fetch_report()" data-toggle="tooltip" data-placement="bottom" title="{{ delivery_create_tooltip|safe }}" onClick=""> 
                {{ delivery_create_report }}
            </button>
        </div>

        <div class="col-4 hidden" id="downloadReport">
            <button type="button" class="btn btn-lg btn-block btn-secondary" onClick="download_report()" data-toggle="tooltip" data-placement="bottom" title="{{ delivery_download_tooltip|safe }}"onClick=""> 
                {{ delivery_download }}
            </button>
        </div>

        <div class="col-4 hidden" id="bookReport">
            <button type="button" class="btn btn-lg btn-block btn-warning" data-toggle="tooltip" data-placement="bottom" title="{{ delivery_book_tooltip|safe }}" onClick=""> 
                {{ delivery_book }}
            </button>
            
            <div class="d-flex justify-content-center mt-1" data-toggle="collapse" href="#collapseBookWarning" role="button" aria-expanded="false" aria-controls="collapseBookWarning">
                <img src="{{ url_for('static', filename='img/exclamation-mark.png') }}" style="width:10%; opacity: 0.5">
            </div>

            <div class="collapse py-3" id="collapseBookWarning">
                <div class="card card-body">
                    <p class="text-muted"><small>{{ delivery_book_tooltip }}</small></p>
                </div>
            </div>
            
        </div>
        
    </div>


    <!-- product summary -->
    <div class="hidden" id="summarySection">
        <hr class="py-2">
        
        <div class="row" id="productSummary">

            <div class="col-12">
                <h3>{{ delivery_category_table_name }}</h3>
            </div>

            <div class="col-12">

                <div class="card-deck my-3 text-center">
        
                    <!-- products -->
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_product_overview }}</h4>
                        </div>
                    <div class="card-body">
                        <p class="mt-3 mb-4 text-muted">{{ delivery_product_overview_description }}</p>
                        
                        <hr>
                        
                        <div class="" id="productTablePlaceholder">
                            
                            <!-- table generation -->

                        </div>
                        
                    </div>
                    </div>

                    <!-- categories -->
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_category_overview }}</h4>
                        </div>
                    <div class="card-body">
                        <p class="mt-3 mb-4 text-muted">{{ delivery_category_overview_description }}</p>

                        <hr>

                        <h4 class="mt-4">{{ delivery_category_table_section_name }}</h4>

                        <div class="table-responsive" id="categoryTablePlaceholder">
                            
                            <!-- table generation -->

                        </div>
                    </div>
                    </div>
                
                    <!-- total earnings -->
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_total_earnings }}</h4>
                        </div>
                        <div class="card-body">
                            <p class="mt-3 mb-4 text-muted">{{ delivery_total_earnings_description }}</p>
                            
                            <h1 class="card-title earnings-card-title"><span id="earningsPlaceholder">0</span>€</h1>
                            
                        </div>

                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_total_spendings }}</h4>
                        </div>
                        <div class="card-body">
                            <p class="mt-3 mb-4 text-muted">{{ delivery_total_spendings_description }}</p>
                            
                            <h1 class="card-title earnings-card-title"><span id="spendingsPlaceholder">0</span>€</h1>
                            
                        </div>

                    </div>
                </div>

            </div>
            

            
        </div>

        <!-- orders -->
        <div class="row mt-3" style="margin-bottom:100px">

            <div class="col-12">
                <h2>{{ delivery_orders_table_name }}</h2>

            </div>

            <div class="col-12" id="ordersTablePlaceholder">
                            
                <!-- table generation -->

            </div>

            
            
        </div>
    </div>

</div>

{% endblock %}

{% block script %}
<script>

    // create vars
    var total_earnings = 0;
    var total_spendings = 0;
    var product_overview_raw = null;
    var category_overview_raw = null;
    var orders_overview_raw = null;
    var n_product_cols = 0;
    var n_category_cols = 0;
    var n_orders_cols = 4;

    // get html elements
    var earnings_placeholder = document.getElementById('earningsPlaceholder');
    var spendings_placeholder = document.getElementById('spendingsPlaceholder');
    var category_table_palceholder = document.getElementById('categoryTablePlaceholder');
    var product_table_palceholder = document.getElementById('productTablePlaceholder');
    var product_summary = document.getElementById('productSummary');
    var orders_table_placeholder = document.getElementById('ordersTablePlaceholder');


    function empty_tr(n_cols, editable) {
        /* creates a empty table row
        
        params:
        -------
        n_columns : int
            Number of columns for the row
        element : html element
            The element to append to
        editable : bool
            If true, the element is editable
            
        returns:
        --------
        html
            The empty row

        */

        // create table row tag
        var tr = document.createElement('tr');

        // append cells to it
        for (var i = 0; i < n_cols; i++) {

            var td = document.createElement('td');
            td.innerHTML="";

            // create cell
            if (editable) {
                td.contentEditable = "true";
            };

            // append as child
            tr.appendChild(td);

        };

        // add remove icon
        var td = document.createElement('td');
        var icon = document.createElement('i');
        icon.classList.add("fa-solid", "fa-circle-minus", "fa-lg", "table-remove")
        td.appendChild(icon);
        tr.append(td);

        return tr
    };

    function create_table(data, editable) {
        /* creates a table and returns it

        params:
        -------
        data : json-object
            The data to use for the population.
                Format: {
                    'data':{
                        col:[values],
                        col:[values],
                        col:[values],
                        ....
                    },
                    'order':[],
                    'mapping':[]
                }
        editable : bool
            if true, the rows are editable

        returns:
        --------
        html object
            The generated table.

        */

        // get col names
        var cols = data.order;
        var n_cols = cols.length;
        var cols_names = data.mapping;
        var values = data.data;

        // get the length of the table
        var n_entries = values[cols[0]].length;

        // create table element
        var tbl = document.createElement('table');
        tbl.classList.add("table", "table-hover", "table-sm");

        // add head
        var tblh = document.createElement('thead');
        tblh.classList.add("thead-dark");
        var tblh_tr = document.createElement('tr');
        // only for the 'head' columns: to identify during book!
        tblh_tr.classList.add("head");
        
        // populate thead
        for (i = 0; i < n_cols; i++) {
            
            // create element
            var th = document.createElement('th');
            th.scope = "col";
            th.headers = cols[i];

            // set inner html
            th.innerHTML = cols_names[i];

            // check if col contains underscores -> indicatdes to hide
            if (cols_names[i].includes("_") || cols_names[i] == "id") {
                th.classList.add("hidden");
            };

            // add to table-head-row
            tblh_tr.appendChild(th);

        };

        // add col for remover
        if (editable) {
            var th = document.createElement('th');
            th.scope = "col";
            th.setAttribute('style', "width:5%");
            //th.headers = "remover_remover";

            // append
            tblh_tr.appendChild(th);
        }

        // add the table-head-row to table-head
        tblh.appendChild(tblh_tr);
        tbl.appendChild(tblh);

        // create table body
        var tbody = document.createElement('tbody');

        // populate body
        for (r = 0; r < n_entries; r++) {

            // create table row
            var tr = document.createElement('tr');

            for (c = 0; c < n_cols; c++) {

                // create table cell
                if (c == 0) {
                    var th = document.createElement('th');
                } else {
                    var th = document.createElement('td');
                };

                // should be invisible?
                if (cols_names[c].includes("_") || cols_names[c] == "id") {
                    th.classList.add("hidden");
                };

                // editable?
                if (editable) {
                    th.setAttribute('contenteditable', "true");
                };

                // add col name
                th.innerHTML = values[cols[c]][r];

                // append to table-row
                tr.appendChild(th);
            };

            // add remover cell
            if (editable) {
                
                // create cell
                var th = document.createElement('td');
                th.innerHTML = "<i class='fa-solid fa-circle-minus fa-lg table-remove'></i>";

                // add to row
                tr.appendChild(th);
            };

            // append table row to table body
            tbody.appendChild(tr);
        };

        // append table body
        tbl.appendChild(tbody)

        return tbl

    };

    function populate_category_tables(data, element, is_category, is_editable) {
        /* Creates a product table

        Creates a table based on the data and appends
        it to the product table div.

        params:
        -------
        data : json-object
            The data to parse.
                Format: 
                    for product: {
                        'category_name':{
                            'data':{
                                'product_name':[],
                                'quantity':[],
                                'cost':[]
                            },
                            'order':[],
                            'mapping':[],
                        },
                        'category_name':{
                            ...
                        },
                        ...
                    }
                    for cateogry:{
                        'data': {
                            'product_name':[],
                            'subcat_1:[],
                            'subcat_2:[],
                            'subcat_X:[],
                            ...
                        },
                        'order':[],
                        'mapping':[]
                    }
        element : html element
            Element to append to.
        is_category : bool
            if true the data belongs to category

        returns:
        --------
        null

        */ 
                    // TBD: Das Datenobjekt hat jetzt mehr info. {order, mapping, data}
                    // wir müssen the originalen werte als value hinzufügen..
                    // brauchen wir fürs zurückspielen.
                    //https://stackoverflow.com/questions/1557602/jquery-and-ajax-response-header
                    // https://codepen.io/redmangospros/pen/POVmwQ/
                    // https://stackoverflow.com/questions/14643617/create-table-using-javascript


        // check if it is_category
        if (is_category) {

            // create table
            var tbl = create_table(data, is_editable);

            // append to element
            element.appendChild(tbl);

        } else {

            // get columns (of the first product)
            var products = Object.keys(data);

            for (p = 0; p < products.length; p++) {

                // create table name
                var h4 = document.createElement('h4');
                h4.innerHTML = products[p];
                h4.classList.add("mt-4")

                // add to element
                element.appendChild(h4);

                // create meta div for table-responsive
                var div = document.createElement('div');
                div.classList.add("table-responsive");

                // create table for data
                var tbl = create_table(data[products[p]], is_editable);

                // append to element
                div.appendChild(tbl);

                // add table adder (if editable)
                if (is_editable) {
                    var tbl_adder = document.createElement('div');
                    //div.classList.add("col-12");
                    tbl_adder.classList.add("text-center");
                    tbl_adder.innerHTML = "<i class='table-add fa-solid fa-circle-plus fa-xl'></i>";

                    div.appendChild(tbl_adder);
                };

                element.appendChild(div);


            };
            
        };

        // make visible
        element.classList.remove('hidden');

        return
    };

    function fetch_report() {
        /* fetches the report and populates the tables */

        var url = "{{ url_for('to_api', ressource='delivery/create') }}";


        // call server and get data
        $.ajax({
            type:'POST',
            url:"{{ url_for('to_api', ressource='delivery/create') }}",
            data:{}
        }).done(function(response){

            if (response.success) {

                // populate product overview
                populate_category_tables(
                    response.data.overview_product, 
                    product_table_palceholder,
                    false
                    );

                // populate cateogry overview
                populate_category_tables(
                    response.data.overview_category, 
                    category_table_palceholder,
                    true
                    );

                // populate total earnings
                total_earnings = response.data.total_earnings;
                earnings_placeholder.innerHTML = total_earnings;

                // populate total spendings
                total_spendings = response.data.total_spendings;
                spendings_placeholder.innerHTML = total_spendings;

                // populate product overview
                populate_category_tables(
                    data = response.data.town_based, 
                    element = ordersTablePlaceholder,
                    is_category = false,
                    is_editable = true
                );


                // make other buttons & product summary visible
                document.getElementById('downloadReport').classList.remove("hidden");
                document.getElementById('bookReport').classList.remove("hidden");
                document.getElementById('summarySection').classList.remove("hidden");

            } else {

                // toast
            };

        })
    };

    function download_report() {
        /* just downloads the report */

        book(checkout=false, table_id="#ordersTablePlaceholder");

        return
    };

    // add on click remover for dynamically added elements
    $('#ordersTablePlaceholder').on("click", '.table-remove', function () {
        //detach the parent tr
        $(this).parents('tr').detach();
    });

    $('#ordersTablePlaceholder').on("click", ".table-add", function() {

        // get the table
        var tbl = $(this).parents().children('table');

        // get number of columns
        var n_cols = 0;

        tbl.find('thead').children('tr').children().each(function() {
            if (!$(this).text().includes("_") && $(this).text() != "id"){
                n_cols++;
            };
        });

        // subtract 1 because of the remover
        n_cols--

        // generate empty row
        var tr = empty_tr(n_cols, true);

        // attach
        tbl.children('tbody').append(tr);

    });

    function book(checkout, table_collection_id ="#ordersTablePlaceholder") {
        /* Books or just creates tables 
        
        This function handles the table parsing
        and sends it to the backend to either
        book or just download the excel.

        params:
        -------
        checkout : bool
            If true, the current state is booked,
            else it just generates the excel.
        table_id : str
            The id of the table to parse

        returns:
        --------
        excel | json
        
        */

        //downloads_path = str(Path.home() / "Downloads")
        
        // grab table
        var collection = $(table_collection_id);

        // create array for data
        var data = []

        // cycle through each table
        collection.find('table').each(function() {

            //get table data
            data.push(get_table_values($(this)));

        });

        // concat data
        data = [].concat(...data);

        // ajax call for the correct method
        if (checkout) {

            // call book

        } else {

            // call excel 1
            $.ajax({
                type:'POST',
                url:"{{ url_for('to_api', ressource='delivery/cover') }}",
                data:{
                    'data':JSON.stringify(data)
                }
            }).done(function(response, textStatus, request) {

                if (response.success) {

                    var blob = new Blob([string_to_array_buffer(window.atob(response.data.content))], {type:""})
                    var blobURL = URL.createObjectURL(blob);
                
                    const a = document.createElement('a')
                    a.href = blobURL;
                    a.download = response.data.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    //window.navigator.msSaveBlob(blob, response.data.name)

                } else {


                    // check if response is object or string
                    if (typeof response == "object") {

                        console.log(response);
                        // its a json -> toast the error

                        } else {

                        console.log(typeof response.error);


                        // create text decoder
                        var enc = new TextDecoder("utf-8");

                        // create blob & add decoded bytestring
                        //var blob = new Blob([enc.decode(response)]);
                        var ab = string_to_array_buffer(response);
                        var bytes = enc.decode(ab);
                        console.log(bytes)
                        var blob = new Blob([string_to_array_buffer(response)])

                        var blobURL = URL.createObjectURL(blob);
                        //window.location.replace(blobURL);


                        response.blob()

                        }

                }



                
            })

        };

        


    };

    function get_table_values(table) {
        /* Grabs all table values 
        
        Grabs all values from a table and returns
        an array containing json-objects for each row.

        params:
        -------
        table : html element
            the table to parse

        returns:
        --------
        array
        
        */
        
        // grab table
        var TABLE = table

        // grab headers
        var cols = [];

        TABLE.find('thead').children('tr').children().each(function() {
            
            // get headers value
            var headers = $(this).attr('headers');

            if (headers != null) {
                cols.push(headers);
            };
        });

        // create data array
        var data = [];

        // create flat data & iterate
        // see: https://stackoverflow.com/questions/2448051/how-can-i-select-all-elements-without-a-given-class-in-jquery
        TABLE.find('tr:not(.head').each(function () {

            // find all 'td's for row
            var tmp_td = $(this).children();
            var h = {};

            // cycle through headers and apply to h
            // CAUTION: automatically kills the last col (-> no idx for it!)
            cols.forEach(function (col, c) {

                // add key:text at idx[c]
                h[col] = tmp_td.eq(c).text();
            });

            // add to data
            data.push(h);

        });

        return data
    };

    // create string to array buffer function
    // see here https://stackoverflow.com/questions/34993292/how-to-save-xlsx-data-to-file-as-a-blob
    function string_to_array_buffer(s) {

        /* converst the strint to array buffer */

        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);

        for (var i=0; i!=s.length; i++) {
            view[i] = s.charCodeAt(i) & 0xFF;
        }

        return buf;
    };
        







    
</script>
{% endblock %}