{% extends "html/base.html" %}

{% block title %} {{ delivery_title }} {% endblock %}

{% block body %}

<!-- Header -->
<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <h1 class="display-4">{{ delivery_title }}</h1>
    <p class="lead">{{ delivery_lead }}</p>
</div>

<!-- settings -->
<div class="container">
    
    <!-- buttons row -->
    <div class="row force-min-height">

        <div class="col-4" id="fetchReport">
            <button type="button" class="btn btn-lg btn-block btn-info" onClick="fetch_report()" data-toggle="tooltip" data-placement="bottom" title="{{ delivery_create_tooltip|safe }}" onClick=""> 
                {{ delivery_create_report }}
            </button>
        </div>

        <div class="col-4 hidden" id="downloadReport">
            <button type="button" class="btn btn-lg btn-block btn-secondary" onClick="download_report()" data-toggle="tooltip" data-placement="bottom" title="{{ delivery_download_tooltip|safe }}"onClick=""> 
                {{ delivery_download }}
            </button>
        </div>

        <div class="col-4 hidden" id="bookReport">
            <button type="button" class="btn btn-lg btn-block btn-warning" data-toggle="tooltip" data-placement="bottom" title="{{ delivery_book_tooltip|safe }}" onClick=""> 
                {{ delivery_book }}
            </button>
            
            <div class="d-flex justify-content-center mt-1" data-toggle="collapse" href="#collapseBookWarning" role="button" aria-expanded="false" aria-controls="collapseBookWarning">
                <img src="{{ url_for('static', filename='img/exclamation-mark.png') }}" style="width:10%; opacity: 0.5">
            </div>

            <div class="collapse py-3" id="collapseBookWarning">
                <div class="card card-body">
                    <p class="text-muted"><small>{{ delivery_book_tooltip }}</small></p>
                </div>
            </div>
            
        </div>
        
    </div>


    <!-- product summary -->
    <div class="hidden" id="summarySection">
        <hr class="py-2">
        
        <div class="row" id="productSummary">

            <div class="col-12">
                <h3>{{ delivery_category_table_name }}</h3>
            </div>

            <div class="col-12">

                <div class="card-deck my-3 text-center">
        
                    <!-- products -->
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_product_overview }}</h4>
                        </div>
                    <div class="card-body">
                        <p class="mt-3 mb-4 text-muted">{{ delivery_product_overview_description }}</p>
                        
                        <hr>
                        
                        <div class="" id="productTablePlaceholder">
                            
                            <!-- table generation -->

                        </div>
                        
                    </div>
                    </div>

                    <!-- categories -->
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_category_overview }}</h4>
                        </div>
                    <div class="card-body">
                        <p class="mt-3 mb-4 text-muted">{{ delivery_category_overview_description }}</p>

                        <hr>

                        <h4 class="mt-4">{{ delivery_category_table_section_name }}</h4>

                        <div class="table-responsive" id="categoryTablePlaceholder">
                            
                            <!-- table generation -->

                        </div>
                    </div>
                    </div>
                
                    <!-- total earnings -->
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_total_earnings }}</h4>
                        </div>
                        <div class="card-body">
                            <p class="mt-3 mb-4 text-muted">{{ delivery_total_earnings_description }}</p>
                            
                            <h1 class="card-title earnings-card-title"><span id="earningsPlaceholder">0</span>€</h1>
                            
                        </div>

                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">{{ delivery_total_spendings }}</h4>
                        </div>
                        <div class="card-body">
                            <p class="mt-3 mb-4 text-muted">{{ delivery_total_spendings_description }}</p>
                            
                            <h1 class="card-title earnings-card-title"><span id="spendingsPlaceholder">0</span>€</h1>
                            
                        </div>

                    </div>
                </div>

            </div>
            

            
        </div>

        <!-- orders -->
        <div class="row mt-3" style="margin-bottom:100px">

            <div class="col-12">
                <h2>{{ delivery_orders_table_name }}</h2>

            </div>

            <div class="" id="ordersTablePlaceholder">
                            
                <!-- table generation -->

            </div>

            <div class="col-12">
                <table class="table" id="testTable">
                    <span class="table-add fa-solid fa-circle-plus fa-xl"></span>
                    <thead class="thead-dark">
                    <tr class="head">
                        <th scope="col" headers="#" >#</th>
                        <th scope="col" headers="First">First</th>
                        <th scope="col" headers="Last">Last</th>
                        <th scope="col" headers="NoHandle">Handle</th>
                        <th scope="col" style="width:5%"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td scope="row">1</td>
                        <td contenteditable="true">Larry</td>
                        <td contenteditable="true">the Bird</td>
                        <td contenteditable="true">@twitter</td>
                        <td><i class="fa-solid fa-circle-minus fa-lg table-remove"></i></td>
                    </tr>
                    <tr>
                        <td scope="row">2</td>
                        <td contenteditable="true">Larry</td>
                        <td contenteditable="true">the Bird</td>
                        <td contenteditable="true">@twitter</td>
                        <td><i class="fa-solid fa-circle-minus fa-lg table-remove"></i></td>
                    </tr>
                    <tr>
                        <td scope="row">3</td>
                        <td contenteditable="true">Larry</td>
                        <td contenteditable="true">the Bird</td>
                        <td contenteditable="true">@twitter</td>
                        <td><i class="fa-solid fa-circle-minus fa-lg table-remove"></i></td>
                    </tr>
                    </tbody>
                </table>
                
                

            </div>
            
        </div>
    </div>

</div>

{% endblock %}

{% block script %}
<script>

    // create vars
    var total_earnings = 0;
    var total_spendings = 0;
    var product_overview_raw = null;
    var category_overview_raw = null;
    var orders_overview_raw = null;
    var n_product_cols = 0;
    var n_category_cols = 0;
    var n_orders_cols = 4;

    // get html elements
    var earnings_placeholder = document.getElementById('earningsPlaceholder');
    var spendings_placeholder = document.getElementById('spendingsPlaceholder');
    var category_table_palceholder = document.getElementById('categoryTablePlaceholder');
    var product_table_palceholder = document.getElementById('productTablePlaceholder');
    var product_summary = document.getElementById('productSummary');
    var orders_table_placeholder = document.getElementById('ordersTablePlaceholder');


    function empty_tr(n_cols, editable) {
        /* creates a empty table row
        
        params:
        -------
        n_columns : int
            Number of columns for the row
        element : html element
            The element to append to
        editable : bool
            If true, the element is editable
            
        returns:
        --------
        html
            The empty row

        */

        // create table row tag
        var tr = document.createElement('tr');

        // append cells to it
        for (var i = 0; i < n_cols; i++) {

            var td = document.createElement('td');
            td.innerHTML="";

            // create cell
            if (editable) {
                td.contentEditable = "true";
            };

            // append as child
            tr.appendChild(td);

        };

        // add remove icon
        var td = document.createElement('td');
        var icon = document.createElement('i');
        icon.classList.add("fa-solid", "fa-circle-minus", "fa-lg", "table-remove")
        td.appendChild(icon);
        tr.append(td);

        return tr
    };

    function create_table(data, editable) {
        /* creates a table and returns it

        params:
        -------
        data : json-object
            The data to use for the population.
                Format: {
                    'data':{
                        col:[values],
                        col:[values],
                        col:[values],
                        ....
                    },
                    'order':[],
                    'mapping':[]
                }
        editable : bool
            if true, the rows are editable

        returns:
        --------
        html object
            The generated table.

        */

        // get col names
        var cols = data.order;
        var n_cols = cols.length;
        var cols_names = data.mapping;
        var values = data.data;

        // get the length of the table
        var n_entries = values[cols[0]].length;

        // create table element
        var tbl = document.createElement('table');
        tbl.classList.add("table", "table-hover", "table-sm");

        // add head
        var tblh = document.createElement('thead');
        tblh.classList.add("thead-dark");
        var tblh_tr = document.createElement('tr');
        // only for the 'head' columns: to identify during book!
        tblh_tr.classList.add("head");
        
        // populate thead
        for (i = 0; i < n_cols; i++) {
            
            // create element
            var th = document.createElement('th');
            th.scope = "col";
            th.headers = cols[i];

            // set inner html
            th.innerHTML = cols_names[i];

            // add to tblh_tr
            tblh_tr.appendChild(th);

        };

        // add the tblh_tr to tblh
        tblh.appendChild(tblh_tr);
        tbl.appendChild(tblh);

        // create table body
        var tbody = document.createElement('tbody');

        // populate
        for (r = 0; r < n_entries; r++) {

            // create tr
            var tr = document.createElement('tr');

            for (c = 0; c < n_cols; c++) {

                // create th
                var th = document.createElement('th');

                // add col name
                th.innerHTML = values[cols[c]][r];

                // append
                tr.appendChild(th);
            };

            // append tr
            tbody.appendChild(tr);
        };

        // append table body
        tbl.appendChild(tbody)

        return tbl

    };

    function populate_category_tables(data, element, is_category) {
        /* Creates a product table

        Creates a table based on the data and appends
        it to the product table div.

        params:
        -------
        data : json-object
            The data to parse.
                Format: 
                    for product: {
                        'category_name':{
                            'data':{
                                'product_name':[],
                                'quantity':[],
                                'cost':[]
                            },
                            'order':[],
                            'mapping':[],
                        },
                        'category_name':{
                            ...
                        },
                        ...
                    }
                    for cateogry:{
                        'data': {
                            'product_name':[],
                            'subcat_1:[],
                            'subcat_2:[],
                            'subcat_X:[],
                            ...
                        },
                        'order':[],
                        'mapping':[]
                    }
        element : html element
            Element to append to.
        is_category : bool
            if true the data belongs to category

        returns:
        --------
        null

        */ 
                    // TBD: Das Datenobjekt hat jetzt mehr info. {order, mapping, data}
                    // wir müssen the originalen werte als value hinzufügen..
                    // brauchen wir fürs zurückspielen.
                    //https://stackoverflow.com/questions/1557602/jquery-and-ajax-response-header
                    // https://codepen.io/redmangospros/pen/POVmwQ/
                    // https://stackoverflow.com/questions/14643617/create-table-using-javascript


        // check if it is_category
        if (is_category) {

            // create table
            var tbl = create_table(data, false);

            // append to element
            element.appendChild(tbl);

        } else {

            // get columns (of the first product)
            var products = Object.keys(data);

            for (p = 0; p < products.length; p++) {

                // create table name
                var h4 = document.createElement('h4');
                h4.innerHTML = products[p];
                h4.classList.add("mt-4")

                // add to element
                element.appendChild(h4);

                // create meta div for table-responsive
                var div = document.createElement('div');
                div.classList.add("table-responsive");

                // create table for data
                var tbl = create_table(data[products[p]], false);

                // append to element
                div.appendChild(tbl);
                element.appendChild(div);
            };
            
        };

        // make visible
        element.classList.remove('hidden');

        return
    };

    function fetch_report() {
        /* fetches the report and populates the tables */

        var url = "{{ url_for('to_api', ressource='delivery/create') }}";


        // call server and get data
        $.ajax({
            type:'POST',
            url:"{{ url_for('to_api', ressource='delivery/create') }}",
            data:{}
        }).done(function(response){

            if (response.success) {

                // populate product overview
                populate_category_tables(
                    response.data.overview_product, 
                    product_table_palceholder,
                    false
                    );

                // populate cateogry overview
                populate_category_tables(
                    response.data.overview_category, 
                    category_table_palceholder,
                    true
                    );

                // populate total earnings
                total_earnings = response.data.total_earnings;
                earnings_placeholder.innerHTML = total_earnings;

                // populate total spendings
                total_spendings = response.data.total_spendings;
                spendings_placeholder.innerHTML = total_spendings;

                // populate product overview


                // make other buttons & product summary visible
                document.getElementById('downloadReport').classList.remove("hidden");
                document.getElementById('bookReport').classList.remove("hidden");
                document.getElementById('summarySection').classList.remove("hidden");



            } else {

                // toast
            };

        })
    };

    function download_report() {
        /* just downloads the report */

        book(checkout=false, table_id="#testTable");

        return
    };

    // like above only for dynamically generated
    $('#testTable').on("click", '.table-remove', function() {
        
        // detach the parent tr
        $(this).parents('tr').detach();
    });

    $('.table-add').click(function() {

        // create empty row
        var tr = empty_tr(n_orders_cols, true);
        
        // attach to the table
        $('#testTable').children('tbody').append(tr);
    
    });

    function book(checkout, table_id ="#ordersTable") {
        /* Books or just creates tables 
        
        This function handles the table parsing
        and sends it to the backend to either
        book or just download the excel.

        params:
        -------
        checkout : bool
            If true, the current state is booked,
            else it just generates the excel.
        table_id : str
            The id of the table to parse

        returns:
        --------
        excel | json
        
        */

        // grab table
        var TABLE = $(table_id);

        // grab headers
        var cols = [];

        TABLE.find('thead').children('tr').children().each(function() {
            
            // get headers value
            var headers = $(this).attr('headers');

            if (headers != null) {
                cols.push(headers);
            };
        });

        // create data array
        var data = [];

        // create flat data & iterate
        // see: https://stackoverflow.com/questions/2448051/how-can-i-select-all-elements-without-a-given-class-in-jquery
        TABLE.find('tr:not(.head').each(function () {
            // find all 'td's for row
            var tmp_td = $(this).find('td:not(.table-remove)');
            var h = {};

            // cycle through headers and apply to h
            cols.forEach(function (col, c) {

                // add key:text at idx[c]
                h[col] = tmp_td.eq(c).text();
            });

            // add to data
            data.push(h);

        });

        // show in logs
        console.log(data);

        


    };






    
</script>
{% endblock %}